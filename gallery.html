<!DOCTYPE html>  
<html>  
<head>
<link rel="stylesheet" href="new.css">    
<style>
body {
  display: grid;
  grid-column-gap: 50px;
  grid-row-gap: 50px;
  grid-template-columns: repeat(4, auto);
}

button {
  cursor: pointer;
}
</style>
</head>

<body>
   <div class="loading"><div class="load"></div></div>
<script>
let source, load
window.gallery = undefined;
let liked = []
let disliked = []
window.addEventListener('beforeunload', function(e) {
  localStorage.setItem('likeditem', JSON.stringify(liked));
  localStorage.setItem('dislikeditem', JSON.stringify(disliked));
})
document.body.style.backgroundColor = 'black'

function send(num) {
  let xhr = new XMLHttpRequest();
  let link = "https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY&count=" + num
  xhr.open('GET', link, true);
  xhr.send();
  xhr.onreadystatechange = function() {
    console.log('yes')
    if (xhr.readyState === 4) {
      source = JSON.parse(xhr.responseText);
      document.querySelector('.loading').style.display = 'none'
      document.body.style.backgroundColor = 'white'
      if (gallery) {
        gallery.forEach(item => {
          item.style.opacity = 1
        })
      }
      create()
    }
  }
}

function create() {

  for (let i = 0; i < source.length; i++) {

    let title = source[i].title;
    let date = source[i].date
    let url = source[i].url
    let service = source[i].service_version
    let media = source[i].media_type
    let copyright = source[i].copyright
    if (!copyright) {
      copyright = '<i>Unknown</i>'
    }
    let content = source[i].explanation.split(' ').slice(0, 20).join(' ')
    document.body.innerHTML += `
       <div class='gallery'>
     
        <div class='pho'>
         <img class='ori' src=${url}>
         </div>
         <div class='allcontent'>
         <div class='title'>Title: ${title}</div>
         <hr class='hr'>
         <div class='date'>Date: ${date}</div>
          <div class='copyright'>Copyright: ${copyright}</div>
          <div class='media'>Media_type: ${media}</div>
          <div class='service'>Service_version: ${service}</div>
         <div class='content'>Explanation: ${content}
         ......
         </div>
         <button class='details'>Show details</button><br>
         <button class='likebutton'>Like</button>  
         <button class='dislikebutton'>Dislike</button>

         </div>
       `
    if (i == source.length - 1) {
      create2(document.body)
    }

    let border = [...document.querySelectorAll('.pho')];
    let img = document.querySelectorAll('img')
    let likebutton = document.querySelectorAll('.likebutton')
    let dislikebutton = document.querySelectorAll('.dislikebutton')
    let details = document.querySelectorAll('.details')
    gallery = [...document.querySelectorAll('.gallery')]
    let explanation = document.querySelectorAll('.content')
    let all = document.querySelectorAll('.allcontent')
    let hr = document.querySelectorAll('hr')
    let mediainfo = document.querySelectorAll('.media')
    let serviceinfo = document.querySelectorAll('.service')
    let alltitle = document.querySelectorAll('.title')
    //Apply eventListener to all the element
    for (let y in border) {
      function check() {
        if (liked.includes(source[y])) {
          liked.splice(liked.indexOf(source[y]), 1)
        } else if (disliked.includes(source[y])) {
          disliked.splice(disliked.indexOf(source[y]), 1)
        }
      }
      border[y].addEventListener('mouseenter', function() {
        img[y].style.transform = 'scale(1.3)'
      })
      border[y].addEventListener('mouseleave', function() {
        img[y].style.transform = 'scale(1)'
      })


      img[y].onerror = function() {
        this.style.display = 'none';
        let error = document.createElement('div')
        error.innerHTML = "We are sorry but at this time we are unable to load <i>this image</i> or doesn't support <i>this type of media</i>"
        error.className = 'error'
        border[y].appendChild(error)
      }
      likebutton[y].addEventListener('click', function() {
        if (this.textContent === 'Like') {
          this.classList.add('clicked')
          this.textContent = "Liked"
          dislikebutton[y].classList.remove('clicked')
          dislikebutton[y].textContent = "Dislike"
          check()
          liked.push(source[y])
        } else {
          this.classList.remove('clicked')
          this.textContent = "Like"
          check()

        }
      })
      dislikebutton[y].addEventListener('click', function() {
        if (this.textContent === 'Dislike') {
          this.classList.toggle('clicked')
          this.textContent = "Disliked"
          likebutton[y].classList.remove('clicked')
          likebutton[y].textContent = "Like"
          check()
          disliked.push(source[y])
        } else {
          this.classList.toggle('clicked')
          this.textContent = "Dislike"
          check()
        }
      })



      details[y].addEventListener('click', function() {
        if (details[y].textContent === 'Show details') {
          window.scrollTo(0, 0)
          alltitle[y].style.fontSize = '40px'
          mediainfo[y].style.display = 'revert'
          serviceinfo[y].style.display = 'revert'
          gallery[y].classList.add('more')
          alltitle[y].style.fontSize = '30px'
          explanation[y].textContent = "Explanation: " + source[i].explanation
          gallery[y].style.opacity = 1;
          img[y].classList.add('new')
          border[y].classList.add('new')
          hr[y].classList.remove('hr')
          all[y].classList.add('all')
          gallery.forEach(item => {
            if (item !== gallery[y])
              item.style.opacity = 0.3
          })

          removebutton = document.createElement('button')
          removebutton.className = 'remove'
          removebutton.textContent = "X"
          details[y].innerHTML = '<b><i>Hide details</i></b>'
          details[y].classList.add('newdetails')
          gallery[y].appendChild(removebutton)
          document.querySelectorAll(".allmore").forEach(item => {
            item.style.opacity = '0.3'
          })

          removebutton.addEventListener('click', function() {
            alltitle[y].style.fontSize = '18px'
            mediainfo[y].style.display = 'none'
            serviceinfo[y].style.display = 'none'
            img[y].classList.remove('new')
            border[y].classList.remove('new')
            gallery[y].classList.remove('more')
            details[y].classList.remove('newdetails')
            all[y].classList.remove('all')
            explanation[y].textContent = "Explanation: " + source[i].explanation.split(' ').slice(0, 20).join(' ')
            details[y].textContent = 'Show details'
            gallery.forEach(item => {
              item.style.opacity = 1
            })
            document.querySelectorAll(".allmore").forEach(item => {
              item.style.opacity = '0.3'
            })
            removebutton.remove()
          })


        } else {
          removebutton.click()
        }

      })
    }
  }
}

function create2(ele) {
  ele.innerHTML += `
  <button onclick = "window.location.href ='home.html'" class='allmore home'>Homepage</button>
  <button class='allmore history' onclick= "window.location.href ='history.html'">History</button>
     <button class='allmore morebutton'>Show Me More</button>
   `
  let allmore = document.querySelectorAll(".allmore")
  let more = document.querySelector('.allmore.morebutton')
  more.addEventListener('click', function() {
    allmore.forEach(item => {
      item.remove()
    })
    send(24)
    document.querySelector(".loading").style.display = ""
    document.body.style.backgroundColor = 'black'
    gallery.forEach(item => {
      item.style.opacity = 0
    })

  })
}
window.addEventListener("load", function() {
  send(20)
})

</script>
</body>
</html>
